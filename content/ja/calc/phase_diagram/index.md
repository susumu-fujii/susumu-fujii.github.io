---
title: '状態図を作成してみよう'
date: '2024-04-26'
private: true
---

### 状態図の作り方
状態図の作り方は単純で、考えたい組成範囲に含まれる化合物のエネルギーをあらかた計算すれば作れます。

今回はBaOとZrO2の擬二元系状態図を作ってみましょう。
energyというディレクトリの中に、03_phase_diagramというディレクトリがあります。
さらにその中に、mp-\*\*\*という名前のディレクトリがたくさんあります。
これがBaOとZrO2の組み合わせで合成される可能性のある化合物の候補です。
これらを一気に計算してみましょう。

### POTCARの作り方
今回はついでにPOTCARの作り方も学んでもらいます。
[POTCAR](https://www.vasp.at/wiki/index.php/POTCAR)には擬ポテンシャルの情報が入っています。
前のページの最後で、第一原理計算は大体電子数の３乗に比例して重くなると書いたと思います。
一方で、原子の内殻にある電子はほとんどの場合価電子と相互作用しないので、状態を固定してしまっても問題ない場合が多いです。
このような内殻電子の寄与をちゃんと計算せずに、単なるポテンシャル関数に置き換えてしまって計算を速くしよう、というのが擬ポテンシャルです。

VASPの擬ポテンシャルは/home/share/vaspPOTCARs/potpaw_PBE54/に置いてありますので、lsで見てみてください。
同じ元素でも色んな種類のPOTCARがあると思います。
POTCARによって、どこまでを価電子とするか等が違っています。

計算用のPOTCARは、以下のように作ります。

```bash
cat /home/share/vaspPOTCARs/potpaw_PBE54/Ba_sv/POTCAR > POTCAR
cat /home/share/vaspPOTCARs/potpaw_PBE54/Zr_sv/POTCAR >> POTCAR
cat /home/share/vaspPOTCARs/potpaw_PBE54/O/POTCAR     >> POTCAR
```

ここで、>はファイルに書き込む、>>はファイルの後に追記するという意味です。
各元素の情報を、 POSCARの中で現れる順にPOTCARに書き込んでくという訳です。
何を書き込んだか確認したければ、以下のコマンドを実行してください。

```bash
grep TITEL POTCAR
```

どの擬ポテンシャルを使えば良いかは場合によりますが、多くの場合で上手くいく擬ポテンシャルはVASPの公式で示されています。
[このページ](https://www.vasp.at/wiki/index.php/Available_PAW_potentials)を開いてください。
Recommended potentials for DFT calculationsというセクションがあって、その下にテーブルが書いてあると思います。
その中の太字のものが、おすすめの擬ポテンシャルです。
例えばLiだと、「Li」と「**Li_sv**」というのがテーブルに書かれていて、太字になっている**Li_sv**というのがおすすめの擬ポテンシャル、ということになります。
これを使いたかったら、

```bash
cat /home/share/vaspPOTCARs/potpaw_PBE54/Li_sv/POTCAR > POTCAR
```

とすれば、POTCARに書き込むことができます。

それでは、以下の手順で各化合物のPOTCARを用意してみてください。

1. 化合物のディレクトリ（mp-\*\*\*）に移動
2. catやlessでPOSCARに書かれている元素の順番を確認（６行目です）
3. 上記の手順でPOTCARを作成
4. 1-3を全部の化合物で終わるまで繰り返す

例えばmp-1342_Ba1O1だと、６行目に

```
Ba O
```

と書いてあります。
この場合、

```bash
cat /home/share/vaspPOTCARs/potpaw_PBE54/Ba_sv/POTCAR > POTCAR
cat /home/share/vaspPOTCARs/potpaw_PBE54/O/POTCAR     >> POTCAR
```

とすればPOTCARが作成できます。

```bash
grep TITEL POTCAR
```
とすると、

```
   TITEL  = PAW_PBE Ba_sv 06Sep2000
   TITEL  = PAW_PBE O 08Apr2002 
```

と表示されて、BaとOの情報がPOTCARに書かれたことが確認できます。

ちなみにPOTCARに含める元素の情報を間違えると、計算がめちゃくちゃになってしまうので、vasp.logやOUTCARを確認して何かがおかしいと気づいたらqdelコマンドでジョブを消して下さい。

### 一気に計算を回す（array job）

POTCARを作り終わったら、計算を回してみましょう。
mp-\*\*\*というディレクトリがある場所に、go.shとlist.datがあると思います。
list.datの中をcatかlessで見てください。
各化合物のディレクトリ名が１行ずつ書いてあると思います。
ここで、以下のコマンドを実行してください。

```bash
qsub -t 1-10 go.sh
```

こうすると、10個の計算が一気にジョブ管理システムに投入されます。
それぞれのジョブに、1から10の異なる番号がSGE_TASK_IDという変数として与えられるようになってます。
go.shの中身をちょっとだけ改良していて、list.datからSGE_TASK_IDに書かれた番号の行を抜き出して、計算を始める前にそのディレクトリに移動するようになっています。
なのでコマンド一つで異なる10個の計算を始めることが出来ます。
やろうと思ったらスパコンで1000個だろうが10000個だろうが回せます（すごい）。

### 状態図を作る
計算が終わったら、database.csvというファイルに、以下のような感じで計算結果をvimコマンドを使って書き込んでいってください。

```bash
id,composition,energy
mp-1342,Ba1 O1,-12.40065454
```

一列目はディレクトリのID、二列目はPOSCARに含まれている元素とその数をスペースで区切ったもの、三列目はOUTCARから抜き出したエネルギーです。
エネルギーの記入が終わったら、以下のプログラムを回してみてください。

```bash
python get_computed_phase_diagram.py
```

詳しく説明しませんが、database.csvを読み込んで、[pymatgen](https://pymatgen.org)というライブラリを使って状態図をhtml形式で出力してくれます。
上手く実行できたら、cpd.htmlというファイルが出来ているので、ダウンロードしてブラウザで開いてみてください。
縦軸が形成エネルギーですが、二元系状態図が見れるはずです（縦軸を圧力や温度にするにはもう数段重い計算が必要です）。
安定なのは、BaO、Ba2ZrO4、Ba3Zr2O7、BaZrO3、ZrO2だけで、後の化合物は形成エネルギーが正なので合成されないことが分かります。
（そういう化合物はマウスカーソルを合わせるとどれくらいエネルギーが高いかも見れます）。
各化合物がどれくらいエネルギー的に安定・不安定か（つまり各元素の化学ポテンシャル）が分かるのが、計算の良いところです。

ちなみにやろうと思ったら三元系状態図でも作ることが出来ます。
BaO-ZrO2-Sc2O3の擬三元系状態図を作りたかったら、その範囲に含まれる化合物のエネルギーをひたすら計算すれば良いです。
今回のチュートリアルではわざわざやりませんが、[こういうやつ](cpd.html)が作成出来ます。
取りうる平衡状態が分かるので、実験の参考にもなるはずです。


### Materials Project
計算はPOSCAR、つまり化合物の結晶構造が分からないと計算を始められないのが弱点です。
基本的にICSDなど、結晶構造のデータベースなどから構造ファイル（cif形式）を取ってきて、それをPOSCAR形式に直して使うのが一般的です。
最近では、第一原理計算のデータベースがすでに作られていて、すごく便利になっています。
例えば米国の[Materials Project](https://next-gen.materialsproject.org)には、化合物の計算データが16万件弱あります。
すごいので、一回Googleアカウントとかでログインして使ってみてください（誰でも無料で使えます。）

既知の化合物は概ね計算されているので、Materials ProjectからPOSCARなどをダウンロードして使うこともできます。
Pythonのプログラムを書けば、POSCARや物性データを一気にダウンロードすることも出来ます。
ただし、Materials Projectのデータは計算条件が甘いものも多いので、本気で研究したいときはPOSCARだけダウンロードして、自分で計算し直した方が良いです。

ちなみに、上のmp-\*\*\*というのは、実はMaterials Project上で化合物につけられたIDです。
今回計算してもらった化合物は、Materials ProjectからダウンロードしたPOSCARの中から、一部を僕が抜粋したものになります。
状態図を作るときに使ったPymatgenというPythonライブラリも、そのMaterials Projectの一環で作成されています。
